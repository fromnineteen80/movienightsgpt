<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0c0f" />
  <title>MovieNightGPT</title>
  <style>
    html, body { height: 100%; }
    body {
      margin:0;
      background:#0b0c0f;
      color:#f3f4f6;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    header {
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      position: sticky;
      top: 0;
      background: rgba(11,12,15,0.92);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      z-index: 10;
    }

    h1 { margin:0; font-size:18px; font-weight:900; letter-spacing:0.2px; }
    #meta { opacity:0.72; font-size:12px; margin-top:4px; }

    .actions { display:flex; gap:8px; align-items:center; }
    button {
      background: rgba(255,255,255,0.10);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:850;
      font-size:12px;
    }
    button.secondary { opacity:0.92; font-weight:750; }

    main { padding: 6px 12px 18px; }

    .section { margin-top:14px; }
    .section h2 { margin: 0 0 10px; font-size:13px; letter-spacing:0.2px; opacity:0.92; }

    .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    @media (min-width: 720px){ .grid { grid-template-columns: repeat(4, 1fr);} }

    .card {
      position:relative;
      border-radius:14px;
      overflow:hidden;
      background:#12141a;
      cursor:pointer;
      border:1px solid rgba(255,255,255,0.06);
    }
    .poster {
      width:100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      display:block;
      background:#0f1116;
    }
    .info { padding:10px 10px 12px; }
    .title { font-weight:900; font-size:13px; line-height:1.25; }
    .sub { margin-top:6px; font-size:12px; opacity:0.78; line-height:1.35; }
    .card.disabled { opacity:0.55; filter:saturate(0.6); cursor:default; }

    .badge {
      position:absolute; top:10px; right:10px;
      background: rgba(12,12,14,0.72);
      border:1px solid rgba(255,255,255,0.14);
      padding:6px 8px; border-radius:999px;
      display:flex; align-items:center; gap:6px;
      backdrop-filter: blur(10px);
      max-width: 80%;
      overflow:hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .star { color:#f6c453; font-size:14px; line-height:1; }
    .badge span { font-size:11px; opacity:0.92; }

    /* Player overlay */
    #playerOverlay { position:fixed; inset:0; background:#000; display:none; z-index:9999; }
    #playerWrap { position:absolute; inset:0; display:flex; flex-direction:column; }
    #playerTop {
      height:54px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 12px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.72), rgba(0,0,0,0));
      position:relative;
      z-index:2;
      gap:10px;
    }
    #closeBtn {
      background: rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.20);
      color:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-weight:950;
      font-size:12px;
      flex: 0 0 auto;
    }
    #nowTitle { font-size:13px; opacity:0.95; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    #iframeBox { position:relative; flex:1; }
    #ytFrame { position:absolute; inset:0; width:100%; height:100%; border:0; }

    /* Settings dialog */
    dialog {
      width:min(560px, calc(100% - 24px));
      border:1px solid rgba(255,255,255,0.16);
      border-radius:16px;
      background:#0f1116;
      color:#f3f4f6;
      padding:14px;
    }
    dialog::backdrop { background: rgba(0,0,0,0.70); }

    label { display:block; font-size:12px; opacity:0.86; margin:10px 0 6px; }
    input[type="text"]{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.16);
      background:#0b0c0f;
      color:#fff;
      font-size:13px;
    }
    .row { display:flex; gap:10px; justify-content:flex-end; margin-top:12px; flex-wrap: wrap; }
    .hint { font-size:12px; opacity:0.76; line-height:1.35; margin-top:8px; }
    .tiny { font-size:12px; opacity:0.66; margin-top:10px; }

    .empty {
      opacity:0.82;
      font-size:12px;
      padding:10px 2px 0;
    }
    .error {
      margin-top:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(255,80,80,0.35);
      background: rgba(255,0,0,0.10);
      color:#ffd4d4;
      white-space:pre-wrap;
      font-size:12px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>MovieNightGPT</h1>
      <div id="meta">Loading…</div>
    </div>
    <div class="actions">
      <button id="chatBtn" class="secondary">Chat</button>
      <button id="refreshBtn" class="secondary">Refresh</button>
      <button id="settingsBtn">Settings</button>
    </div>
  </header>

  <main id="content"></main>

  <div id="playerOverlay" aria-hidden="true">
    <div id="playerWrap">
      <div id="playerTop">
        <div id="nowTitle"></div>
        <button id="closeBtn">Close</button>
      </div>
      <div id="iframeBox">
        <iframe id="ytFrame" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen
          referrerpolicy="strict-origin-when-cross-origin"></iframe>
      </div>
    </div>
  </div>

  <dialog id="settingsDialog">
    <form method="dialog">
      <h2 style="margin:0 0 8px; font-size:14px;">Settings</h2>

      <div class="hint">
        Paste your GitHub Gist raw URLs here once. The MovieNightGPT Controller writes to those files.
      </div>

      <label for="picksUrl">Picks raw URL (picks.json)</label>
      <input id="picksUrl" type="text" placeholder="https://gist.githubusercontent.com/USERNAME/GIST_ID/raw/picks.json" />

      <label for="overrideUrl">Tonight raw URL (override.json)</label>
      <input id="overrideUrl" type="text" placeholder="https://gist.githubusercontent.com/USERNAME/GIST_ID/raw/override.json" />

      <div class="hint">
        Leave blank to use the public file in this repo: <b>data/today.json</b>
      </div>

      <div class="row">
        <button id="clearBtn" class="secondary" value="cancel">Clear</button>
        <button id="saveBtn" value="default">Save</button>
      </div>

      <div class="tiny">Tip: add this page to your iPhone home screen.</div>
    </form>
  </dialog>

  <script>
    const PUBLIC_BASELINE_URL = "./data/today.json";
    const DEFAULT_ROW_TITLES = ["Recently Uploaded","Popular","Political","War","History"];

    const LS_PICKS_URL = "mn_picks_url";
    const LS_OVERRIDE_URL = "mn_override_url";

    let loadSeq = 0;

    const elMeta = document.getElementById("meta");
    const elContent = document.getElementById("content");

    const overlay = document.getElementById("playerOverlay");
    const closeBtn = document.getElementById("closeBtn");
    const nowTitle = document.getElementById("nowTitle");
    const ytFrame = document.getElementById("ytFrame");

    const settingsBtn = document.getElementById("settingsBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const chatBtn = document.getElementById("chatBtn");

    const settingsDialog = document.getElementById("settingsDialog");
    const picksUrlInput = document.getElementById("picksUrl");
    const overrideUrlInput = document.getElementById("overrideUrl");
    const clearBtn = document.getElementById("clearBtn");
    const saveBtn = document.getElementById("saveBtn");

    function ytEmbedUrl(videoId) {
      return `https://www.youtube.com/embed/${encodeURIComponent(videoId)}?autoplay=1&playsinline=1&rel=0&modestbranding=1`;
    }
    function safeText(s){ return (s ?? "").toString(); }

        function lsGet(k){
      try { return localStorage.getItem(k); } catch (_) { return null; }
    }
    function lsSet(k, v){
      try { localStorage.setItem(k, v); } catch (_) {}
    }

    function getPicksUrl(){ return lsGet(LS_PICKS_URL) || ""; }
    function getOverrideUrl(){ return lsGet(LS_OVERRIDE_URL) || ""; }
    function setPicksUrl(v){ lsSet(LS_PICKS_URL, v); }
    function setOverrideUrl(v){ lsSet(LS_OVERRIDE_URL, v); }

function clearUrls(){
      localStorage.removeItem(LS_PICKS_URL);
      localStorage.removeItem(LS_OVERRIDE_URL);
    }

        const YT_ID_RE = /^[a-zA-Z0-9_-]{11}$/;
    const PLACEHOLDER_POSTER = "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="400" height="600" viewBox="0 0 400 600"><rect width="400" height="600" fill="#151622"/><rect x="24" y="24" width="352" height="552" rx="18" fill="#0f1018" stroke="#2a2c3b"/><path d="M132 250h136v100H132z" fill="#1b1d2a" stroke="#2a2c3b"/><path d="M185 230l70 70-70 70z" fill="#2a2c3b"/><text x="200" y="430" text-anchor="middle" fill="#8c8fa3" font-family="-apple-system,system-ui,Segoe UI,Roboto" font-size="18">No poster</text></svg>`);

    function mkCard(m) {
      const title = safeText(m.title);
      const year = safeText(m.year);
      const titleLine = `${title}${year ? ` (${year})` : ""}`;

      const director = safeText(m.director);
      const leads = Array.isArray(m.leads) ? m.leads.map(safeText) : (m.leads ? [safeText(m.leads)] : []);
      const awardsArr = Array.isArray(m.awards) ? m.awards.map(safeText).filter(Boolean) : [];
      const awardsText = awardsArr.join(", ");
      const hasStar = awardsArr.length > 0;

      const yt = safeText(m.youtubeId).trim();
      const ytOk = YT_ID_RE.test(yt);

      const div = document.createElement("div");
      div.className = "card" + (ytOk ? "" : " disabled");
      if (ytOk) div.dataset.yt = yt;
      div.dataset.title = titleLine;

      if (hasStar) {
        const badge = document.createElement("div");
        badge.className = "badge";
        const star = document.createElement("div");
        star.className = "star";
        star.textContent = "★";
        const span = document.createElement("span");
        span.textContent = awardsText;
        badge.appendChild(star);
        badge.appendChild(span);
        div.appendChild(badge);
      }

      const img = document.createElement("img");
      img.className = "poster";
      img.loading = "lazy";
      img.alt = titleLine;

      const posterUrl = safeText(m.posterUrl).trim();
      img.src = posterUrl || PLACEHOLDER_POSTER;
      img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER_POSTER; };
      div.appendChild(img);

      const info = document.createElement("div");
      info.className = "info";

      const t = document.createElement("div");
      t.className = "title";
      t.textContent = titleLine;
      info.appendChild(t);

      if (director) {
        const d = document.createElement("div");
        d.className = "meta";
        d.textContent = `Director: ${director}`;
        info.appendChild(d);
      }
      if (leads.length) {
        const l = document.createElement("div");
        l.className = "meta";
        l.textContent = `Leads: ${leads.join(", ")}`;
        info.appendChild(l);
      }

      div.appendChild(info);

      div.addEventListener("click", () => {
        if (!ytOk) return;
        ytFrame.src = ytEmbedUrl(yt);
        overlay.style.display = "block";
        overlay.setAttribute("aria-hidden", "false");
        document.body.style.overflow = "hidden";
      });

      return div;
    }


    function mkSection(title, items) {
      const section = document.createElement("section");
      section.className = "section";

      const h2 = document.createElement("h2");
      h2.textContent = title;

      const grid = document.createElement("div");
      grid.className = "grid";
      (items || []).forEach(m => grid.appendChild(mkCard(m)));

      section.appendChild(h2);
      section.appendChild(grid);
      return section;
    }

    function closePlayer() {
      ytFrame.src = "about:blank";
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }
    closeBtn.addEventListener("click", closePlayer);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) closePlayer(); });

    settingsBtn.addEventListener("click", () => {
      picksUrlInput.value = getPicksUrl();
      overrideUrlInput.value = getOverrideUrl();
      settingsDialog.showModal();
    });

    clearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      picksUrlInput.value = "";
      overrideUrlInput.value = "";
      clearUrls();
      settingsDialog.close();
      loadAll();
    });

    saveBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const p = picksUrlInput.value.trim();
      const o = overrideUrlInput.value.trim();
      if (p) setPicksUrl(p); else localStorage.removeItem(LS_PICKS_URL);
      if (o) setOverrideUrl(o); else localStorage.removeItem(LS_OVERRIDE_URL);
      settingsDialog.close();
      loadAll();
    });

    refreshBtn.addEventListener("click", () => loadAll());

    chatBtn.addEventListener("click", () => {
      const picks = getPicksUrl();
      const override = getOverrideUrl();
      const msg =
        `Use MovieNightGPT Controller.\n\n` +
        `My picks.json raw URL: ${picks || "[not set]"}\n` +
        `My override.json raw URL: ${override || "[not set]"}\n\n` +
        `If my tastes are not set, ask me for my favorite genres. Then write picks.json.\n` +
        `If I ask what to watch tonight, write override.json.\n`;
      const url = "https://chat.openai.com/?q=" + encodeURIComponent(msg);
      window.open(url, "_blank", "noopener,noreferrer");
    });

    async function fetchJson(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) {
        const t = await r.text().catch(() => "");
        throw new Error(`Fetch ${r.status} ${r.statusText}: ${url}${t ? `\n${t.slice(0,200)}` : ""}`);
      }
      return await r.json();
    }

    function isOverrideValid(o) {
      if (!o || o.enabled !== true) return false;
      if (!o.expires_et) return true;
      const expires = new Date(o.expires_et);
      if (isNaN(expires.getTime())) return true;
      return Date.now() < expires.getTime();
    }

    async function loadBaseline() {
      const picksUrl = getPicksUrl();
      if (picksUrl) {
        try { return await fetchJson(picksUrl); } catch (e) { /* fall through */ }
      }
      return await fetchJson(PUBLIC_BASELINE_URL);
    }

    function renderError(msg) {
      const box = document.createElement("div");
      box.className = "error";
      box.textContent = msg;
      elContent.appendChild(box);
    }

    async function loadAll() {
      const seq = ++loadSeq;
      elMeta.textContent = "Loading…";
      elContent.innerHTML = "";

      let baseline;
      try {
        baseline = await loadBaseline();
        if (seq !== loadSeq) return;
      } catch (err) {
        elMeta.textContent = "Could not load";
        renderError(err && err.message ? err.message : "Unknown error");
        elContent.appendChild(Object.assign(document.createElement("div"), { className: "empty", textContent: "Open Settings and paste your Gist raw URLs." }));
        return;
      }

      const dateStr = baseline.date ? baseline.date : "";
      const criteriaStr = baseline.criteria ? baseline.criteria : "";
      elMeta.textContent = [dateStr, criteriaStr].filter(Boolean).join(" · ") || "";

      // Tonight row (optional)
      const overrideUrl = getOverrideUrl();
      if (overrideUrl) {
        try {
          const o = await fetchJson(overrideUrl);
          if (seq !== loadSeq) return;
          if (isOverrideValid(o) && Array.isArray(o.items) && o.items.length) {
            elContent.appendChild(mkSection(o.title || "Tonight", o.items.slice(0,4)));
          }
        } catch (e) {
          // silent
        }
      }

      const items = Array.isArray(baseline.items) ? baseline.items : [];
      const rowTitles = Array.isArray(baseline.row_titles) && baseline.row_titles.length
        ? baseline.row_titles
        : DEFAULT_ROW_TITLES;

      // Always render all row titles (5 rows), even if empty.
      for (let i = 0; i < rowTitles.length; i++) {
        const start = i * 4;
        const rowItems = items.slice(start, start + 4);
        elContent.appendChild(mkSection(rowTitles[i] || `Row ${i+1}`, rowItems));
      }

      if (!items.length) {
        elContent.appendChild(Object.assign(document.createElement("div"), { className: "empty", textContent: "No movies yet. Use Chat to tell the Controller what you like, then it will write picks.json." }));
      }
    }

    window.addEventListener("error", (e) => {
      try {
        elMeta.textContent = "Error";
        if (!elContent.innerHTML) renderError(e.message || "Script error");
      } catch (_) {}
    });

    loadAll();
  </script>
</body>
</html>
